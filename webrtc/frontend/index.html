<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Websockets with Earnstein</title>

    <style>
      body {
        overflow: hidden;
        padding: 10px;
        margin: 0;
        width: 100%;
        height: 100%;
        background-color: beige;
      }

      .center {
        margin: auto;
        width: 50%;
        border: 3px solid green;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="center">
      <h1>Granular x chat application.</h1>
      <h3 id="chat-header">Currently in chat: general</h3>
      <h3 id="connection-header">Connected to websocket: false</h3>
      <form id="chatroom-selection">
        <label for="chatroom">Chatroom:</label>
        <input type="text" id="chatroom" name="chatroom" /> <br />
        <input type="submit" value="Change chatroom" />
      </form>
      <br />
      <textarea
        name="chatmessages"
        id="chatmessages"
        readonly
        cols="50"
        rows="5"
        class="messagearea"
        placeholder="Welcome to chatroom"
      ></textarea>
      <br />

      <form id="chatroom-message">
        <label for="message">Chatroom:</label>
        <input type="text" id="message" name="message" /> <br />
        <input type="submit" value="Send message" />
      </form>


      <div style="border: 3px solid black; margin: 30px; padding: 10px;">
        <form id="login-form">
            <label for="username">Username:</label>
            <input type="text" id="username" name="username"> <br>
            <label for="password">Password:</label>
            <input type="password" id="password" name="password"> <br>
            <input type="submit" value="Login">
        </form>
      </div>
    </div>

    <script>
      var selectedChat = "general";

      class Event {
        constructor(type, data) {
          this.type = type;
          this.data = data;
        }
      }

      function routeEvent(event) {
        if (event.type === undefined) {
          alert("Event has no type");
        }
        switch (event.type) {
          case "new_message":
            var message = event.data;
            console.log(`New message: ${message}`);
            break;
          default:
            alert("Unsupported message type");
            break;
        }
      }

      function sendEvent(eventName, data) {
        const event = new Event(eventName, data);
        conn.send(JSON.stringify(event));
      }
      function changeChatRoom() {
        var newChat = document.getElementById("chatroom");
        if (newChat != null && newChat.value != selectedChat) {
          console.log(newChat);
        }
        return false;
      }

      function sendMessage() {
        var newMessage = document.getElementById("message");
        if (newMessage != null) {
          sendEvent("send_message", newMessage.value);
        }
        return false;
      }

      function login() {
        var username = document.getElementById("username");
        var password = document.getElementById("password");
       const formData = {username: username.value, password: password.value}
       fetch("http://localhost:8080/login", {
         method: "POST",
         body: JSON.stringify(formData),
         mode: "cors",
       }).then((response) => {
         if (response.ok) {
           console.log("Login successful");
           return response.json();
         } else {
           console.error("Login failed");
           throw "Unathourised"
         }
       }).then((data) => {
         console.log(data);
         connectWebsocket(data.otp);
       }).catch((error) => {
         console.error(error);
         alert(error);
       });
      }

      function connectWebsocket(otp) {
        if (window["WebSocket"]) {
          console.log("web socket supported");
          conn = new WebSocket("ws://localhost:8080/ws?otp=" + otp);

          conn.onopen = function () {
            document.getElementById("connection-header").innerHTML = "Connected to websocket: true";
          };

          conn.onclose = function () {
            document.getElementById("connection-header").innerHTML = "Connected to websocket: false";
            // reconnection
          };
          conn.onmessage = function (e) {
            const eventData = JSON.parse(e.data);
            const event = Object.assign(new Event(), eventData);
            routeEvent(event);
          };
        } else {
          alert("Browser does not supports websocket");
        }
      }

      window.onload = function () {
        document.getElementById("chatroom-selection").onsubmit = changeChatRoom;
        document.getElementById("chatroom-message").onsubmit = sendMessage;
        document.getElementById("login-form").onsubmit = login;
      };
    </script>
  </body>
</html>
